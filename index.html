<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIRELA - Modern Inspectorate Dashboard</title>
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.9);
            --sidebar-bg: #0f172a; /* Deep Navy Slate */
            --accent-blue: #3b82f6; /* Electric Blue */
            --body-bg: #f1f5f9;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background-color: var(--body-bg);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #1e293b;
            overflow-x: hidden;
        }

        /* Sidebar Styling */
        .sidebar {
            min-width: 280px;
            max-width: 280px;
            background: var(--sidebar-bg);
            color: white;
            min-height: 100vh;
            transition: var(--transition);
            position: fixed;
            z-index: 1000;
            box-shadow: 10px 0 30px rgba(0,0,0,0.1);
        }

        .sidebar-brand {
            padding: 2rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-blue);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .sidebar .nav-link {
            color: #94a3b8;
            padding: 14px 20px;
            margin: 8px 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            transition: var(--transition);
        }

        .sidebar .nav-link i { font-size: 1.1rem; }

        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .sidebar .nav-link.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            width: calc(100% - 280px);
            transition: var(--transition);
        }

        /* Glass Cards */
        .card {
            background: var(--glass-bg);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(8px);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .stat-card {
            border-left: 5px solid var(--accent-blue);
        }

        .stat-card h2 {
            font-weight: 800;
            color: var(--sidebar-bg);
        }

        /* Table Design */
        .table {
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        .table thead th {
            border-bottom: none;
            color: #64748b;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            padding: 15px;
        }

        .table tbody tr {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: var(--transition);
        }

        .table tbody tr td {
            padding: 18px 15px;
            border: none;
        }

        .table tbody tr td:first-child { border-radius: 15px 0 0 15px; }
        .table tbody tr td:last-child { border-radius: 0 15px 15px 0; }

        .table tbody tr:hover {
            transform: scale(1.01);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
            z-index: 2;
        }

        /* Custom Inputs */
        .form-control, .form-select {
            border-radius: 12px;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            transition: var(--transition);
        }

        .form-control:focus {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            border-color: var(--accent-blue);
        }

        .btn-primary {
            background: var(--accent-blue);
            border: none;
            border-radius: 12px;
            padding: 12px 25px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(59, 130, 246, 0.4);
        }

        /* Juknis Styling */
        .juknis-step {
            border-left: 3px solid var(--accent-blue);
            padding-left: 20px;
            margin-bottom: 30px;
            position: relative;
        }
        .juknis-step::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 13px;
            height: 13px;
            background: var(--accent-blue);
            border-radius: 50%;
        }

        /* Loading Animation */
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .spinner-modern {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar { margin-left: -280px; }
            .sidebar.active { margin-left: 0; }
            .main-content { margin-left: 0; width: 100%; }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-modern mx-auto"></div>
            <p class="mt-3 fw-bold text-dark" id="loadingText">Menyiapkan Dashboard...</p>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column" id="sidebar">
        <div class="sidebar-brand">
            <div class="brand-icon">
                <i class="fas fa-shield-halved text-white fa-lg"></i>
            </div>
            <div>
                <h4 class="fw-bold mb-0 text-white" style="letter-spacing: 1px;">SIRELA</h4>
                <small class="text-info opacity-75 fw-bold" style="font-size: 0.65rem;">Sistem Informasi Register Laporan</small>
            </div>
        </div>

        <div class="px-3 mb-4">
            <div class="p-3 rounded-4" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);">
                <small class="text-muted d-block mb-1">Status Sistem</small>
                <div class="d-flex align-items-center gap-2">
                    <span class="pulse-green"></span>
                    <span class="small fw-bold">Operasional Aktif</span>
                </div>
            </div>
        </div>

        <ul class="nav flex-column mb-auto">
            <li class="nav-item">
                <a href="#" class="nav-link active" onclick="switchView('dashboard')">
                    <i class="fas fa-grid-2 me-2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="switchView('input')">
                    <i class="fas fa-file-circle-plus me-2"></i> Input Laporan
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="switchView('register')">
                    <i class="fas fa-folder-tree me-2"></i> Register Laporan
                </a>
            </li>
            <li class="nav-item">
                <hr class="mx-3 opacity-10">
                <a href="#" class="nav-link" onclick="switchView('juknis')">
                    <i class="fas fa-book-open me-2"></i> Juknis SIRELA
                </a>
            </li>
        </ul>

        <div class="p-4" id="previewBadge" style="display:none;">
            <div class="alert alert-info py-2 small mb-0 border-0 text-center" style="background: rgba(59, 130, 246, 0.1); color: #60a5fa;">
                <i class="fas fa-flask me-1"></i> Mode Simulasi
            </div>
        </div>
        
        <div class="mt-auto p-4 text-center opacity-50">
            <small>&copy; 2026 Inspektorat Daerah Kabupaten Lingga</small>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header -->
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-white shadow-sm d-lg-none" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <h2 class="fw-bold mb-0" id="viewTitleDisplay">SIRELA Dashboard</h2>
                    <p class="text-muted mb-0" id="currentDateDisplay">Memuat tanggal...</p>
                </div>
            </div>
            <div class="d-none d-md-flex align-items-center gap-4">
                <div class="text-end">
                    <h5 class="fw-bold mb-0 text-primary" id="currentTimeDisplay">00:00:00</h5>
                    <small class="text-muted">Zona Waktu WIB</small>
                </div>
                <div class="avatar-box bg-white p-2 rounded-circle shadow-sm">
                    <i class="fas fa-user-circle fa-2x text-secondary"></i>
                </div>
            </div>
        </header>

        <!-- View: Dashboard -->
        <div id="view-dashboard" class="view-section animate__animated animate__fadeIn">
            <div class="row g-4" id="statsContainer">
                <!-- Stats will be injected here -->
            </div>
        </div>

        <!-- View: Input Form -->
        <div id="view-input" class="view-section" style="display:none;">
            <div class="card p-4 p-md-5">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <div>
                        <h3 class="fw-bold mb-1">Registrasi Laporan Baru</h3>
                        <p class="text-muted">Lengkapi detail dokumen untuk mendapatkan nomor indeks otomatis.</p>
                    </div>
                    <button class="btn btn-light rounded-pill px-4" onclick="switchView('dashboard')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="reportForm">
                    <input type="hidden" id="formId">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Kategori Laporan</label>
                            <select class="form-select" id="formKategori" required>
                                <option value="">Pilih Kategori Dokumen...</option>
                                <option>Laporan Hasil Reviu</option>
                                <option>Laporan Hasil Audit Ketaatan</option>
                                <option>Laporan Hasil Audit Investigasi</option>
                                <option>Laporan Hasil Audit Tujuan Tertentu</option>
                                <option>Laporan Hasil Audit Kinerja</option>
                                <option>Laporan Hasil Monitoring Kas Opname</option>
                                <option>Laporan Stock Opname</option>
                                <option>Laporan Hasil Evaluasi</option>
                                <option>Laporan Asistensi</option>
                                <option>Laporan Hasil Monitoring</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Tanggal Terbit Laporan</label>
                            <input type="date" class="form-control" id="formTanggal" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">Judul Lengkap Laporan</label>
                            <textarea class="form-control" id="formJudul" rows="3" required placeholder="Contoh: Laporan Hasil Reviu Atas LKPD Pemerintah Kabupaten Lingga Tahun 2023..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Tim / Auditor Penanggung Jawab</label>
                            <input type="text" class="form-control" id="formTim" required placeholder="Contoh: Irban Wilayah I">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Lampiran Digital (Scan Cover)</label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="formCover" accept="image/*" onchange="previewImage(this)">
                                <label class="input-group-text bg-white"><i class="fas fa-upload"></i></label>
                            </div>
                            <div id="previewBox" class="mt-3 p-3 bg-light rounded-4 d-none">
                                <img id="imgPreview" class="img-fluid rounded-3 shadow-sm" style="max-height: 200px;">
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 pt-4 border-top d-flex gap-2">
                        <button type="submit" class="btn btn-primary px-5" id="btnSubmit">
                            <i class="fas fa-check-double me-2"></i> Konfirmasi & Simpan
                        </button>
                        <button type="reset" class="btn btn-light px-4" onclick="resetForm()">Batalkan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View: Register Table -->
        <div id="view-register" class="view-section" style="display:none;">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                    <div>
                        <h3 class="fw-bold mb-1">Register Laporan</h3>
                        <p class="text-muted mb-0">Total ditemukan <span class="badge bg-primary rounded-pill" id="totalCountBadge">0</span> laporan</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success rounded-3" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-2"></i> Excel
                        </button>
                        <button class="btn btn-outline-danger rounded-3" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf me-2"></i> PDF Massal
                        </button>
                        <button class="btn btn-primary" onclick="switchView('input')">
                            <i class="fas fa-plus me-2"></i> Input Baru
                        </button>
                    </div>
                </div>

                <!-- Filter Row -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="small text-muted mb-2 fw-bold">Saring Kategori</label>
                        <select class="form-select border-0 shadow-sm" id="filterKategori" onchange="applyFilter()">
                            <option value="Semua">Semua Kategori</option>
                            <option>Laporan Hasil Reviu</option>
                            <option>Laporan Hasil Audit Ketaatan</option>
                            <option>Laporan Hasil Audit Investigasi</option>
                            <option>Laporan Hasil Audit Tujuan Tertentu</option>
                            <option>Laporan Hasil Audit Kinerja</option>
                            <option>Laporan Hasil Monitoring Kas Opname</option>
                            <option>Laporan Stock Opname</option>
                            <option>Laporan Hasil Evaluasi</option>
                            <option>Laporan Asistensi</option>
                            <option>Laporan Hasil Monitoring</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle" id="mainReportTable">
                        <thead>
                            <tr>
                                <th width="60">No</th>
                                <th width="180">No. Indeks</th>
                                <th width="140">Tanggal</th>
                                <th>Judul Laporan</th>
                                <th width="150">Tim Kerja</th>
                                <th width="80">File</th>
                                <th class="text-center" width="160">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- View: Juknis (Petunjuk Teknis) -->
        <div id="view-juknis" class="view-section" style="display:none;">
            <div class="card p-4 p-md-5">
                <div class="text-center mb-5">
                    <div class="bg-primary bg-opacity-10 d-inline-flex p-3 rounded-circle mb-3">
                        <i class="fas fa-book-open text-primary fa-2x"></i>
                    </div>
                    <h2 class="fw-bold">Petunjuk Teknis (Juknis) SIRELA</h2>
                    <p class="text-muted mx-auto" style="max-width: 600px;">Panduan operasional Sistem Informasi Register Laporan untuk mempermudah tata kelola administrasi di Inspektorat Daerah Kabupaten Lingga.</p>
                </div>

                <div class="row g-4 justify-content-center">
                    <div class="col-lg-10">
                        <div class="juknis-step">
                            <h5 class="fw-bold text-primary">1. Dashboard & Statistik</h5>
                            <p>Halaman utama menyajikan ringkasan jumlah laporan per kategori secara <i>real-time</i>. Gunakan statistik ini untuk memantau produktivitas tim secara keseluruhan.</p>
                        </div>
                        
                        <div class="juknis-step">
                            <h5 class="fw-bold text-primary">2. Cara Input Laporan Baru</h5>
                            <ul class="text-muted">
                                <li>Pilih menu <b>Input Laporan</b> pada sidebar.</li>
                                <li>Pilih kategori laporan yang sesuai.</li>
                                <li>Isi tanggal terbit dan judul lengkap laporan (gunakan huruf kapital pada awal kata penting).</li>
                                <li>Masukkan nama Tim Kerja atau Irban yang bertanggung jawab.</li>
                                <li>Unggah <i>scan cover</i> laporan (opsional) untuk mempermudah identifikasi fisik.</li>
                                <li>Klik <b>Konfirmasi & Simpan</b>. Sistem akan mengenerate nomor indeks otomatis.</li>
                            </ul>
                        </div>

                        <div class="juknis-step">
                            <h5 class="fw-bold text-primary">3. Mengelola Register Laporan</h5>
                            <p>Di halaman <b>Register Laporan</b>, Anda dapat:</p>
                            <ul class="text-muted">
                                <li><b>Filter:</b> Menyaring laporan berdasarkan kategori tertentu.</li>
                                <li><b>Edit:</b> Memperbarui data laporan jika terdapat kesalahan input.</li>
                                <li><b>Hapus:</b> Menghapus data (perlu konfirmasi administrator).</li>
                                <li><b>PDF Individual:</b> Mencetak satu surat register resmi untuk satu laporan tertentu (ikon printer merah).</li>
                            </ul>
                        </div>

                        <div class="juknis-step">
                            <h5 class="fw-bold text-primary">4. Ekspor Data Massal</h5>
                            <p>Tersedia fitur <b>Ekspor Excel</b> dan <b>PDF Massal</b> untuk keperluan pelaporan bulanan atau tahunan. Data yang diekspor akan mengikuti filter yang sedang aktif.</p>
                        </div>

                        <div class="alert alert-warning border-0 bg-warning bg-opacity-10 rounded-4">
                            <div class="d-flex gap-3">
                                <i class="fas fa-circle-info mt-1"></i>
                                <div>
                                    <h6 class="fw-bold mb-1">Penting: Penomoran Indeks</h6>
                                    <small class="d-block">Nomor indeks dihitung secara otomatis berdasarkan urutan per kategori laporan. Jika Anda menghapus data di tengah-tengah, sistem akan tetap menjaga integritas urutan pada inputan berikutnya.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-5 mb-4">
            <div class="d-flex justify-content-center align-items-center gap-2 text-muted">
                <i class="fas fa-bolt text-warning"></i>
                <small>SIRELA Dashboard â€¢ Engineered by <strong>GAS WebApp Builder</strong></small>
            </div>
        </footer>
    </div>

    <!-- Pulse Animation Style -->
    <style>
        .pulse-green {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 rgba(34, 197, 94, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .animate__animated { animation-duration: 0.6s; }
        .cursor-pointer { cursor: pointer; }
    </style>

    <!-- JS Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        // --- GLOBAL STATE ---
        let mockDB = [];
        let filteredDB = [];
        let currentCoverBase64 = "";

        // --- UTILITIES ---
        function startLoading(text = "Sinkronisasi Data...") {
            const overlay = document.getElementById('loadingOverlay');
            if(overlay) {
                document.getElementById('loadingText').innerText = text;
                overlay.style.display = 'flex';
            }
        }

        function endLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if(overlay) overlay.style.display = 'none';
        }

        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(v => {
                v.style.display = 'none';
                v.classList.remove('animate__fadeIn');
            });
            
            const target = document.getElementById('view-' + viewName);
            target.style.display = 'block';
            target.classList.add('animate__fadeIn');
            
            document.querySelectorAll('.sidebar .nav-link').forEach(l => {
                l.classList.remove('active');
                if(l.getAttribute('onclick').includes(viewName)) l.classList.add('active');
            });

            const titles = {
                'dashboard': 'SIRELA Dashboard',
                'input': 'Input Laporan Baru',
                'register': 'Register Laporan',
                'juknis': 'Petunjuk Teknis'
            };
            document.getElementById('viewTitleDisplay').innerText = titles[viewName];

            if(viewName === 'register') loadData();
            if(viewName === 'dashboard') updateDashboard();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function previewImage(input) {
            const file = input.files[0];
            const previewContainer = document.getElementById('previewBox');
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentCoverBase64 = e.target.result;
                    const prev = document.getElementById('imgPreview');
                    prev.src = currentCoverBase64;
                    previewContainer.classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.classList.add('d-none');
            }
        }

        // --- DATABASE LOGIC ---
        function loadData() {
            startLoading("Mengambil Data Register...");
            if (typeof google === 'undefined') {
                setTimeout(() => {
                    endLoading();
                    renderTable(mockDB);
                }, 600);
            } else {
                google.script.run
                    .withSuccessHandler(res => {
                        endLoading();
                        if(res.success) {
                            mockDB = res.data;
                            applyFilter(); 
                            updateDashboard();
                        }
                    })
                    .getAllData();
            }
        }

        function applyFilter() {
            const val = document.getElementById('filterKategori').value;
            if(val === "Semua") {
                filteredDB = mockDB;
            } else {
                filteredDB = mockDB.filter(d => d.kategori === val);
            }
            renderTable(filteredDB);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            const totalBadge = document.getElementById('totalCountBadge');
            tbody.innerHTML = '';
            totalBadge.innerText = data.length;
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">Belum ada riwayat laporan yang terdaftar</td></tr>';
                return;
            }

            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold text-muted text-center">${index + 1}</td>
                    <td><span class="badge bg-light text-primary border px-3 py-2 rounded-pill shadow-sm" style="font-size: 0.75rem;">${row.nomor_indeks}</span></td>
                    <td class="small text-muted">${row.tanggal}</td>
                    <td>
                        <div class="fw-bold text-uppercase" style="font-size: 0.8rem; line-height: 1.4;">${row.judul_laporan}</div>
                        <small class="text-primary fw-bold" style="font-size: 0.7rem;">${row.kategori}</small>
                    </td>
                    <td><span class="text-secondary small fw-bold">${row.tim_penyampai}</span></td>
                    <td class="text-center">
                        ${row.cover ? `<div class="bg-primary bg-opacity-10 p-2 rounded-3 cursor-pointer" onclick="showCover('${row.cover}')"><i class="fas fa-image text-primary"></i></div>` : '<i class="fas fa-minus text-muted"></i>'}
                    </td>
                    <td class="text-center">
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-sm btn-white border shadow-sm" title="Unduh PDF Individual" onclick="exportSinglePDF('${row.id}')"><i class="fas fa-file-pdf text-danger"></i></button>
                            <button class="btn btn-sm btn-white border shadow-sm" title="Edit" onclick="editData('${row.id}')"><i class="fas fa-pen text-warning"></i></button>
                            <button class="btn btn-sm btn-white border shadow-sm" title="Hapus" onclick="confirmDelete('${row.id}')"><i class="fas fa-trash text-danger"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showCover(src) {
            Swal.fire({
                imageUrl: src,
                imageAlt: 'Cover Laporan',
                confirmButtonText: 'Tutup Panel',
                confirmButtonColor: '#3b82f6',
                customClass: { popup: 'rounded-4' }
            });
        }

        // --- EXPORT PDF INDIVIDUAL ---
        function exportSinglePDF(id) {
            const item = mockDB.find(d => d.id == id);
            if(!item) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            startLoading("Mencetak PDF Laporan...");

            // Kop Surat
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("PEMERINTAH KABUPATEN LINGGA", 105, 20, { align: "center" });
            doc.setFontSize(16);
            doc.text("INSPEKTORAT DAERAH", 105, 27, { align: "center" });
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.text("Jl. Protokol No. 1 Daik Lingga, Kepulauan Riau", 105, 33, { align: "center" });
            doc.setLineWidth(0.5);
            doc.line(20, 36, 190, 36);
            doc.setLineWidth(0.2);
            doc.line(20, 37, 190, 37);

            // Judul Dokumen
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("SURAT REGISTER LAPORAN", 105, 50, { align: "center" });
            doc.setFontSize(10);
            doc.text(`Nomor Indeks: ${item.nomor_indeks}`, 105, 56, { align: "center" });

            // Konten dalam Tabel
            doc.autoTable({
                startY: 65,
                theme: 'plain',
                styles: { fontSize: 10, cellPadding: 5 },
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 50 } },
                body: [
                    ['Kategori Laporan', `: ${item.kategori}`],
                    ['Tanggal Terbit', `: ${item.tanggal}`],
                    ['Judul Laporan', `: ${item.judul_laporan}`],
                    ['Tim Penyampai', `: ${item.tim_penyampai}`],
                    ['Status Validasi', ': Terdaftar Secara Elektronik']
                ]
            });

            // Tanda Tangan
            const finalY = doc.lastAutoTable.finalY + 25;
            doc.text("Daik Lingga, " + new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}), 135, finalY);
            doc.text("Petugas Register,", 135, finalY + 7);
            doc.text("( ____________________ )", 135, finalY + 35);
            doc.setFontSize(8);
            doc.text("Dicetak secara otomatis melalui aplikasi SIRELA", 20, doc.internal.pageSize.height - 10);

            doc.save(`Laporan_${item.nomor_indeks.replace(/\//g, '_')}.pdf`);
            
            setTimeout(() => {
                endLoading();
                Swal.fire('Berhasil', 'Dokumen PDF telah diunduh.', 'success');
            }, 500);
        }

        // --- EXPORT LOGIC MASSAL ---
        function exportToExcel() {
            if (filteredDB.length === 0) return Swal.fire('Gagal', 'Tidak ada data untuk diekspor', 'error');
            
            startLoading("Mengekspor ke Excel...");
            
            const dataToExport = filteredDB.map((row, index) => ({
                "No": index + 1,
                "Nomor Indeks": row.nomor_indeks,
                "Kategori": row.kategori,
                "Tanggal Terbit": row.tanggal,
                "Judul Laporan": row.judul_laporan,
                "Tim Auditor": row.tim_penyampai
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Register Laporan");
            
            worksheet['!cols'] = [
                {wch: 5}, {wch: 35}, {wch: 25}, {wch: 15}, {wch: 60}, {wch: 25}
            ];

            const fileName = `Register_Laporan_${new Date().getTime()}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            setTimeout(() => {
                endLoading();
                Swal.fire('Berhasil', 'Data excel telah diunduh.', 'success');
            }, 800);
        }

        function exportToPDF() {
            if (filteredDB.length === 0) return Swal.fire('Gagal', 'Tidak ada data untuk diekspor', 'error');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            startLoading("Menghasilkan Dokumen PDF...");

            doc.setFontSize(16);
            doc.text("REGISTER LAPORAN INSPEKTORAT", 149, 15, { align: "center" });
            doc.setFontSize(10);
            doc.text("Sistem Informasi Register Laporan (SIRELA)", 149, 21, { align: "center" });
            doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')}`, 149, 27, { align: "center" });
            
            doc.line(15, 32, 282, 32);

            const tableRows = filteredDB.map((row, index) => [
                index + 1,
                row.nomor_indeks,
                row.tanggal,
                `${row.judul_laporan}\n(${row.kategori})`,
                row.tim_penyampai
            ]);

            doc.autoTable({
                head: [['No', 'Nomor Indeks', 'Tanggal', 'Judul Laporan & Kategori', 'Tim Kerja']],
                body: tableRows,
                startY: 38,
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 3 },
                headStyles: { fillColor: [15, 23, 42], textColor: [255, 255, 255], fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 60 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 'auto' },
                    4: { cellWidth: 40 }
                }
            });

            const fileName = `Register_Laporan_Massal_${new Date().getTime()}.pdf`;
            doc.save(fileName);
            
            setTimeout(() => {
                endLoading();
                Swal.fire('Berhasil', 'Dokumen PDF massal telah diunduh.', 'success');
            }, 800);
        }

        function updateDashboard() {
            const categories = [
                "Laporan Hasil Reviu", "Laporan Hasil Audit Ketaatan", "Laporan Hasil Audit Investigasi",
                "Laporan Hasil Audit Tujuan Tertentu", "Laporan Hasil Audit Kinerja", "Laporan Hasil Monitoring Kas Opname",
                "Laporan Stock Opname", "Laporan Hasil Evaluasi", "Laporan Asistensi", "Laporan Hasil Monitoring"
            ];
            
            const container = document.getElementById('statsContainer');
            if(!container) return;
            container.innerHTML = '';

            categories.forEach(cat => {
                const count = mockDB.filter(d => d.kategori === cat).length;
                container.innerHTML += `
                    <div class="col-md-4 col-lg-3">
                        <div class="card p-4 stat-card h-100">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="bg-primary bg-opacity-10 p-2 rounded-3">
                                    <i class="fas fa-file-invoice text-primary"></i>
                                </div>
                                <span class="badge bg-light text-dark border-0">Aktif</span>
                            </div>
                            <h2 class="mb-1">${count}</h2>
                            <small class="text-muted fw-bold" style="font-size: 0.65rem; letter-spacing: 0.5px; text-transform: uppercase;">${cat}</small>
                        </div>
                    </div>
                `;
            });
        }

        // --- FORM LOGIC ---
        document.getElementById('reportForm').onsubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('formId').value;
            const payload = {
                id: id,
                kategori: document.getElementById('formKategori').value,
                tanggal: document.getElementById('formTanggal').value,
                judul: document.getElementById('formJudul').value,
                tim: document.getElementById('formTim').value,
                cover: currentCoverBase64
            };

            startLoading("Memproses Pendaftaran...");

            if (typeof google === 'undefined') {
                setTimeout(() => {
                    endLoading();
                    if(id) {
                        const idx = mockDB.findIndex(d => d.id == id);
                        if(idx !== -1) {
                           mockDB[idx] = {...mockDB[idx], ...payload, judul_laporan: payload.judul, tim_penyampai: payload.tim};
                        }
                    } else {
                        const nextNum = mockDB.filter(d => d.kategori === payload.kategori).length + 1;
                        mockDB.push({
                            id: Date.now(),
                            nomor_urut: nextNum,
                            kategori: payload.kategori,
                            nomor_indeks: `REG/${payload.kategori.substring(0,3).toUpperCase()}/${new Date().getFullYear()}/${nextNum}`,
                            tanggal: payload.tanggal,
                            judul_laporan: payload.judul,
                            tim_penyampai: payload.tim,
                            cover: currentCoverBase64
                        });
                    }
                    Swal.fire({ title: 'Berhasil!', text: 'Laporan berhasil terdaftar.', icon: 'success', customClass: { popup: 'rounded-4' } });
                    resetForm();
                    switchView('register');
                }, 1000);
            } else {
                google.script.run
                    .withSuccessHandler(res => {
                        endLoading();
                        if(res.success) {
                            Swal.fire('Berhasil', res.message, 'success');
                            resetForm();
                            loadData();
                            switchView('register');
                        }
                    })
                    .saveData(payload);
            }
        };

        function resetForm() {
            document.getElementById('reportForm').reset();
            document.getElementById('formId').value = "";
            document.getElementById('previewBox').classList.add('d-none');
            currentCoverBase64 = "";
            document.getElementById('btnSubmit').innerHTML = '<i class="fas fa-check-double me-2"></i> Konfirmasi & Simpan';
        }

        function editData(id) {
            const data = mockDB.find(d => d.id == id);
            if(!data) return;

            document.getElementById('formId').value = data.id;
            document.getElementById('formKategori').value = data.kategori;
            document.getElementById('formTanggal').value = data.tanggal;
            document.getElementById('formJudul').value = data.judul_laporan;
            document.getElementById('formTim').value = data.tim_penyampai;
            
            if(data.cover) {
                const prev = document.getElementById('imgPreview');
                prev.src = data.cover;
                document.getElementById('previewBox').classList.remove('d-none');
                currentCoverBase64 = data.cover;
            } else {
                document.getElementById('previewBox').classList.add('d-none');
                currentCoverBase64 = "";
            }

            document.getElementById('btnSubmit').innerHTML = '<i class="fas fa-save me-2"></i> Perbarui Data';
            switchView('input');
        }

        function confirmDelete(id) {
            Swal.fire({
                title: 'Hapus Laporan?',
                text: "Tindakan ini akan menghapus data register secara permanen!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#94a3b8',
                confirmButtonText: 'Hapus Sekarang',
                cancelButtonText: 'Batal',
                customClass: { popup: 'rounded-4' }
            }).then((result) => {
                if (result.isConfirmed) {
                    startLoading("Menghapus Register...");
                    if (typeof google === 'undefined') {
                        setTimeout(() => {
                            endLoading();
                            mockDB = mockDB.filter(d => d.id != id);
                            applyFilter();
                            updateDashboard();
                            Swal.fire('Terhapus', 'Laporan telah dihapus.', 'success');
                        }, 500);
                    } else {
                        google.script.run
                            .withSuccessHandler(res => {
                                endLoading();
                                if(res.success) {
                                    Swal.fire('Berhasil', res.message, 'success');
                                    loadData();
                                }
                            })
                            .deleteData(id);
                    }
                }
            });
        }

        // --- CLOCK & INITIALIZATION ---
        function updateClock() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateDisp = document.getElementById('currentDateDisplay');
            const timeDisp = document.getElementById('currentTimeDisplay');
            if(dateDisp) dateDisp.innerText = now.toLocaleDateString('id-ID', options);
            if(timeDisp) timeDisp.innerText = now.toLocaleTimeString('id-ID') + " WIB";
        }

        window.onload = function() {
            if (typeof google === 'undefined') {
                const badge = document.getElementById('previewBadge');
                if(badge) badge.style.display = 'block';
            }
            setInterval(updateClock, 1000);
            updateClock();
            loadData();
            switchView('dashboard');
        };
    </script>
</body>
</html>
